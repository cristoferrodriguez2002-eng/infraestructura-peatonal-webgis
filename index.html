<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>WebGIS - Infraestructura peatonal</title>

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />

  <style>
    /* Aquí va el estilo que ya tienes... */
  </style>
</head>

<body>
  <header>
    <h1>WebGIS - Afectación de infraestructura peatonal</h1>
    <p>La comunidad reporta problemas en veredas, cruces y accesibilidad.</p>
  </header>

  <div class="layout">
    <!-- Mapa -->
    <div id="map"></div>

    <!-- Formulario -->
    <aside class="panel-formulario">
      <h2>Nuevo reporte ciudadano</h2>
      <p class="help">
        1) Al abrir el visor se intentará usar tu ubicación actual automáticamente.<br />
        2) Si no funciona o prefieres otro lugar, toca el mapa para marcar la ubicación del problema.<br />
        3) Puedes tomar una foto o subirla desde tu galería.<br />
        4) Completa el formulario y presiona <strong>Guardar reporte</strong>.
      </p>

      <form id="form-reporte">
        <!-- Campos del formulario... -->
      </form>

      <div class="lista-reportes">
        <strong>Reportes registrados en esta sesión:</strong>
        <div id="lista-reportes-items"></div>
      </div>
    </aside>
  </div>

  <!-- Leaflet JS -->
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <script>
    // ====================
    // 1. Mapa base
    // ====================
    const map = L.map("map").setView([-37.47, -72.35], 13);

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
      attribution: "&copy; OpenStreetMap contributors"
    }).addTo(map);

    // ====================
    // 2. Estructura de datos en memoria
    // ====================
    let reportes = {
      type: "FeatureCollection",
      features: []
    };

    let capaReportes = L.geoJSON(null, {
      pointToLayer: (feature, latlng) =>
        L.circleMarker(latlng, {
          radius: 7,
          fillColor: getColor(feature.properties.tipo_afectacion),
          color: "#333",
          weight: 1,
          fillOpacity: 0.9
        }),
      onEachFeature: (feature, layer) => {
        const p = feature.properties;
        let html = `
          <b>Tipo de afectación:</b> ${p.tipo_afectacion}<br>
          <b>Superficie:</b> ${p.superficie}<br>
          <b>Severidad:</b> ${p.severidad}<br>
          <b>Iluminación:</b> ${p.iluminacion}<br>
          <b>Accesibilidad:</b> ${p.accesibilidad}<br>
          <b>Fecha:</b> ${p.fecha || "-"}<br>
          <b>Descripción:</b> ${p.descripcion || "-"}
        `;
        if (p.foto_dataurl) {
          html += `<br><img src="${p.foto_dataurl}" alt="Foto del problema" style="max-width:200px; margin-top:4px;">`;
        }
        layer.bindPopup(html);
      }
    }).addTo(map);

    // Para mostrar la ubicación seleccionada antes de guardar
    let marcadorTemporal = null;

    // ====================
    // 3. Selección de punto en el mapa y por GPS
    // ====================
    const latInput = document.getElementById("lat");
    const lngInput = document.getElementById("lng");
    const btnGuardar = document.getElementById("btn-guardar");

    // Foto
    const fotoInput = document.getElementById("foto");
    let fotoDataURLActual = null;

    fotoInput.addEventListener("change", function (e) {
      const file = e.target.files[0];
      if (!file) {
        fotoDataURLActual = null;
        return;
      }
      const reader = new FileReader();
      reader.onload = function (ev) {
        fotoDataURLActual = ev.target.result;
      };
      reader.readAsDataURL(file);
    });

    // Función común para actualizar la ubicación seleccionada
    function actualizarUbicacion(lat, lng) {
      const latFixed = lat.toFixed(6);
      const lngFixed = lng.toFixed(6);

      // Mostrar en el formulario
      latInput.value = latFixed;
      lngInput.value = lngFixed;

      // Habilitar botón de guardar
      btnGuardar.disabled = false;

      const latLngObj = L.latLng(lat, lng);

      // Mostrar marcador temporal
      if (marcadorTemporal) {
        marcadorTemporal.setLatLng(latLngObj);
      } else {
        marcadorTemporal = L.marker(latLngObj, {
          draggable: false
        }).addTo(map);
      }

      // Centrar el mapa en la ubicación seleccionada
      map.setView(latLngObj, map.getZoom());
    }

    // Clic en el mapa
    map.on("click", function (e) {
      actualizarUbicacion(e.latlng.lat, e.latlng.lng);
    });

    // Intentar usar la ubicación actual del dispositivo
    if ("geolocation" in navigator) {
      navigator.geolocation.getCurrentPosition(
        function (pos) {
          const lat = pos.coords.latitude;
          const lng = pos.coords.longitude;
          actualizarUbicacion(lat, lng);
        },
        function (err) {
          console.warn("No se pudo obtener la ubicación del dispositivo:", err);
        },
        {
          enableHighAccuracy: true,
          timeout: 10000
        }
      );
    } else {
      console.warn("Geolocalización no soportada por este navegador.");
    }

    // ====================
    // 4. Asignar color según tipo
    // ====================
    function getColor(tipo) {
      switch (tipo) {
        case "Vereda dañada":
          return "#e41a1c";
        case "Cruce peligroso":
          return "#377eb8";
        case "Inundación en vereda":
          return "#4daf4a";
        case "Iluminación deficiente":
          return "#984ea3";
        default:
          return "#ff7f00";
      }
    }

    // ====================
    // 5. Manejo del formulario
    // ====================
    const form = document.getElementById("form-reporte");
    const listaReportesDiv = document.getElementById("lista-reportes-items");
    let contadorId = 1;

    form.addEventListener("submit", function (e) {
      e.preventDefault();

      // Verifica que el evento submit esté siendo capturado
      console.log('Formulario enviado', {
        lat: latInput.value,
        lng: lngInput.value,
        tipo_afectacion: document.getElementById("tipo_afectacion").value,
        superficie: document.getElementById("superficie").value,
        severidad: document.getElementById("severidad").value,
        iluminacion: document.getElementById("iluminacion").value,
        accesibilidad: document.getElementById("accesibilidad").value,
        descripcion: document.getElementById("descripcion").value
      });

      // Validar que haya coordenadas
      if (!latInput.value || !lngInput.value) {
        alert("Primero selecciona una ubicación (GPS o clic en el mapa).");
        return;
      }

      // Obtener valores del formulario
      const tipo_afectacion = document.getElementById("tipo_afectacion").value;
      const superficie = document.getElementById("superficie").value;
      const severidad = document.getElementById("severidad").value;
      const iluminacion = document.getElementById("iluminacion").value;
      const accesibilidad = document.getElementById("accesibilidad").value;
      const descripcion = document.getElementById("descripcion").value;
      const fecha = document.getElementById("fecha").value;

      if (!tipo_afectacion || !superficie || !severidad || !iluminacion || !accesibilidad) {
        alert("Por favor completa los campos obligatorios.");
        return;
      }

      const lat = parseFloat(latInput.value);
      const lng = parseFloat(lngInput.value);

      // Crear Feature GeoJSON
      const feature = {
        type: "Feature",
        properties: {
          id_reporte: contadorId++,
          tipo_afectacion,
          superficie,
          severidad,
          iluminacion,
          accesibilidad,
          descripcion,
          fecha,
          foto_dataurl: fotoDataURLActual || null
        },
        geometry: {
          type: "Point",
          coordinates: [lng, lat] // GeoJSON es [long, lat]
        }
      };

      // Agregar al FeatureCollection
      reportes.features.push(feature);

      // Agregar al mapa
      capaReportes.addData(feature);

      // Mostrar en lista de la derecha
      const item = document.createElement("div");
      item.className = "item-reporte";
      item.textContent = `${feature.properties.id_reporte}. ${tipo_afectacion} (${severidad}) en ${superficie}`;
      listaReportesDiv.appendChild(item);

      // Limpiar formulario (pero mantener coords y marcador)
      form.reset();
      btnGuardar.disabled = true;
      fotoDataURLActual = null;
    });
  </script>
</body>
</html>
