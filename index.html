<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>WebGIS - Infraestructura peatonal</title>

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />

  <style>
    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
      background: #f5f5f5;
    }

    header {
      padding: 0.75rem 1rem;
      background: #1f2937;
      color: white;
    }

    header h1 {
      margin: 0;
      font-size: 1.1rem;
    }

    header p {
      margin: 0;
      font-size: 0.85rem;
      opacity: 0.8;
    }

    .layout {
      display: grid;
      grid-template-columns: 2fr 1fr;
      height: calc(100vh - 56px);
    }

    #map {
      width: 100%;
      height: 100%;
    }

    .panel-lateral {
      background: #ffffff;
      border-left: 1px solid #e5e7eb;
      padding: 0.75rem 1rem;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .panel-lateral h2 {
      margin-top: 0;
      font-size: 1rem;
    }

    .help {
      font-size: 0.8rem;
      color: #4b5563;
      margin-bottom: 0.5rem;
    }

    button {
      padding: 0.45rem 0.75rem;
      font-size: 0.85rem;
      border-radius: 999px;
      border: 1px solid #111827;
      background: #111827;
      color: white;
      cursor: pointer;
    }

    button.secundario {
      background: white;
      color: #111827;
    }

    .filtros {
      display: flex;
      flex-direction: column;
      gap: 0.4rem;
      font-size: 0.8rem;
    }

    .filtros label {
      font-weight: 600;
    }

    .filtros select {
      width: 100%;
      padding: 0.25rem 0.4rem;
      font-size: 0.8rem;
      border-radius: 0.25rem;
      border: 1px solid #d1d5db;
    }

    .lista-reportes {
      margin-top: 0.25rem;
      border-top: 1px solid #e5e7eb;
      padding-top: 0.5rem;
      font-size: 0.8rem;
    }

    .item-reporte {
      padding: 0.25rem 0;
      border-bottom: 1px dashed #e5e7eb;
    }

    .item-reporte span.tag {
      display: inline-block;
      font-size: 0.7rem;
      background: #e5e7eb;
      border-radius: 999px;
      padding: 0.05rem 0.4rem;
      margin-left: 0.25rem;
    }

    .resumen {
      font-size: 0.8rem;
      color: #374151;
    }

    @media (max-width: 900px) {
      .layout {
        grid-template-columns: 1fr;
        grid-template-rows: auto auto;
        height: auto;
      }

      #map {
        height: 55vh;
      }

      .panel-lateral {
        border-left: none;
        border-top: 1px solid #e5e7eb;
        height: auto;
        padding-bottom: 1.5rem;
      }

      button {
        padding: 0.55rem 0.8rem;
        font-size: 0.9rem;
      }

      .filtros select {
        font-size: 0.9rem;
      }
    }
  </style>
</head>

<body>
  <header>
    <h1>WebGIS - Afectación de infraestructura peatonal</h1>
    <p>Visualizador de reportes ciudadanos sobre veredas, cruces y accesibilidad.</p>
  </header>

  <div class="layout">
    <!-- Mapa -->
    <div id="map"></div>

    <!-- Panel lateral -->
    <aside class="panel-lateral">
      <h2>Panel de control</h2>
      <p class="help">
        Los puntos mostrados corresponden a reportes ciudadanos ya validados y cargados
        en la base de datos. Esta interfaz es de solo lectura para la comunidad.
      </p>

      <!-- Botón al formulario externo (Kobo / Google Forms) -->
      <button
        type="button"
        onclick="window.open('URL_DE_TU_FORMULARIO', '_blank')"
      >
        Abrir formulario ciudadano
      </button>
      <p class="help">
        Usa este botón para responder el cuestionario y enviar nuevos reportes.
        Solo el administrador puede decidir cuáles se integran al mapa.
      </p>

      <!-- Filtros -->
      <div class="filtros">
        <div>
          <label for="filtroTipo">Tipo de afectación:</label>
          <select id="filtroTipo">
            <option value="todos">Todos</option>
            <option value="Vereda dañada">Vereda dañada</option>
            <option value="Cruce peligroso">Cruce peligroso</option>
            <option value="Inundación en vereda">Inundación en vereda</option>
            <option value="Iluminación deficiente">Iluminación deficiente</option>
            <option value="Otro">Otro</option>
          </select>
        </div>

        <div>
          <label for="filtroSeveridad">Severidad:</label>
          <select id="filtroSeveridad">
            <option value="todas">Todas</option>
            <option value="Baja">Baja</option>
            <option value="Media">Media</option>
            <option value="Alta">Alta</option>
          </select>
        </div>

        <button class="secundario" type="button" onclick="resetFiltros()">
          Reiniciar filtros
        </button>
      </div>

      <!-- Resumen -->
      <div class="resumen" id="resumenTexto">
        Cargando reportes...
      </div>

      <!-- Lista de reportes -->
      <div class="lista-reportes">
        <strong>Reportes visibles:</strong>
        <div id="lista-reportes-items"></div>
      </div>
    </aside>
  </div>

  <!-- Leaflet JS -->
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <script>
    // ====================
    // 1. Mapa base
    // ====================
    const map = L.map("map").setView([-37.47, -72.35], 13);

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
      attribution: "&copy; OpenStreetMap contributors"
    }).addTo(map);

    // ====================
    // 2. Variables globales
    // ====================
    let datosOriginales = null;
    let capaReportes = null;

    const filtroTipo = document.getElementById("filtroTipo");
    const filtroSeveridad = document.getElementById("filtroSeveridad");
    const listaReportesDiv = document.getElementById("lista-reportes-items");
    const resumenTexto = document.getElementById("resumenTexto");

    // ====================
    // 3. Funciones de estilo y popup
    // ====================
    function getColor(tipo) {
      switch (tipo) {
        case "Vereda dañada":
          return "#e41a1c";
        case "Cruce peligroso":
          return "#377eb8";
        case "Inundación en vereda":
          return "#4daf4a";
        case "Iluminación deficiente":
          return "#984ea3";
        default:
          return "#ff7f00";
      }
    }

    function crearCapa(geojson) {
      if (capaReportes) {
        capaReportes.remove();
      }

      capaReportes = L.geoJSON(geojson, {
        pointToLayer: (feature, latlng) =>
          L.circleMarker(latlng, {
            radius: 7,
            fillColor: getColor(feature.properties.tipo_afectacion),
            color: "#333",
            weight: 1,
            fillOpacity: 0.9
          }),
        onEachFeature: (feature, layer) => {
          const p = feature.properties || {};
          let html = `
            <b>Tipo de afectación:</b> ${p.tipo_afectacion || "-"}<br>
            <b>Superficie:</b> ${p.superficie || "-"}<br>
            <b>Severidad:</b> ${p.severidad || "-"}<br>
            <b>Iluminación:</b> ${p.iluminacion || "-"}<br>
            <b>Accesibilidad:</b> ${p.accesibilidad || "-"}<br>
            <b>Fecha:</b> ${p.fecha || "-"}<br>
            <b>Descripción:</b> ${p.descripcion || "-"}
          `;
          if (p.foto_url) {
            html += `<br><img src="${p.foto_url}" alt="Foto del problema" style="max-width:200px; margin-top:4px;">`;
          }
          layer.bindPopup(html);
        }
      }).addTo(map);

      if (geojson.features && geojson.features.length > 0) {
        map.fitBounds(capaReportes.getBounds(), { padding: [20, 20] });
      }
    }

    // ====================
    // 4. Cargar datos desde reportes.geojson
    // ====================
    fetch("data/reportes.geojson")
      .then((resp) => resp.json())
      .then((geojson) => {
        datosOriginales = geojson;
        aplicarFiltros(); // crea capa y lista
      })
      .catch((err) => {
        console.error("Error cargando data/reportes.geojson:", err);
        resumenTexto.textContent = "No se pudieron cargar los reportes.";
      });

    // ====================
    // 5. Filtros y resumen
    // ====================
    function aplicarFiltros() {
      if (!datosOriginales) return;

      const tipoSel = filtroTipo.value;
      const sevSel = filtroSeveridad.value;

      const filtradas = {
        ...datosOriginales,
        features: datosOriginales.features.filter((f) => {
          const p = f.properties || {};
          const okTipo = tipoSel === "todos" || p.tipo_afectacion === tipoSel;
          const okSev = sevSel === "todas" || p.severidad === sevSel;
          return okTipo && okSev;
        })
      };

      crearCapa(filtradas);
      actualizarResumenYLista(filtradas);
    }

    function resetFiltros() {
      filtroTipo.value = "todos";
      filtroSeveridad.value = "todas";
      aplicarFiltros();
    }

    filtroTipo.addEventListener("change", aplicarFiltros);
    filtroSeveridad.addEventListener("change", aplicarFiltros);

    function actualizarResumenYLista(geojson) {
      const total = datosOriginales.features.length;
      const visibles = geojson.features.length;

      resumenTexto.textContent =
        "Total de reportes cargados: " +
        total +
        ". Filtrados visibles: " +
        visibles +
        ".";

      listaReportesDiv.innerHTML = "";
      geojson.features.forEach((f) => {
        const p = f.properties || {};
        const div = document.createElement("div");
        div.className = "item-reporte";
        const id = p.id_reporte || "-";
        const tipo = p.tipo_afectacion || "Sin tipo";
        const sev = p.severidad || "-";
        const sup = p.superficie || "-";
        div.innerHTML = `
          <strong>${id}.</strong> ${tipo} en ${sup}
          <span class="tag">${sev}</span><br>
          <span>${p.descripcion || ""}</span>
        `;
        listaReportesDiv.appendChild(div);
      });
    }
  </script>
</body>
</html>
